<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Linac Model AR</title>

    <!-- Load A-Frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

    <!-- Enable WebXR -->
    <script src="https://cdn.rawgit.com/aframevr/aframe/master/examples/showcase/webxr/xr.js"></script>

    <!-- Add your CSS here -->
    <link rel="stylesheet" href="Files/index.css">
  </head>
  <body>
    <a-scene
      xrweb="allowedDevices: any"
      renderer="colorManagement: true"
      vr-mode-ui="enabled: false"
      webxr="optionalFeatures: hit-test; optionalFeatures: local-floor">

      <!-- Define assets -->
      <a-assets>
        <a-asset-item id="01_Bed" src="assets/01_Bed.glb"></a-asset-item>
        <!-- Add other models as needed -->
      </a-assets>

      <!-- AR camera -->
      <a-entity camera position="0 0 0" look-controls webxr="optionalFeatures: hit-test"></a-entity>

      <!-- Ground plane -->
      <a-plane id="ground" rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>

      <!-- Placeholder for the model -->
      <a-entity id="model-placeholder" gltf-model="#01_Bed" scale="0.5 0.5 0.5" visible="false"></a-entity>
    </a-scene>

    <!-- Hit-test and surface placement script -->
    <script>
      AFRAME.registerComponent('surface-placement', {
        init: function () {
          const sceneEl = this.el;
          let hitTestSource = null;
          let hitTestSourceRequested = false;

          this.el.sceneEl.addEventListener('enter-vr', () => {
            const xrSession = this.el.sceneEl.renderer.xr.getSession();
            
            xrSession.requestReferenceSpace('viewer').then((referenceSpace) => {
              xrSession.requestHitTestSource({ space: referenceSpace }).then((source) => {
                hitTestSource = source;
              });
            });

            hitTestSourceRequested = true;

            xrSession.addEventListener('select', (event) => {
              const model = document.querySelector('#model-placeholder');
              const frame = event.frame;

              if (hitTestSource) {
                const viewerPose = frame.getViewerPose(xrSession.renderState.baseLayer);
                const hitTestResults = frame.getHitTestResults(hitTestSource);

                if (hitTestResults.length > 0) {
                  const hit = hitTestResults[0];
                  const position = hit.getPose(referenceSpace).transform.position;
                  model.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
                  model.setAttribute('visible', 'true');
                }
              }
            });
          });
        },
      });

      document.querySelector('a-scene').setAttribute('surface-placement', '');
    </script>
  </body>
</html>
